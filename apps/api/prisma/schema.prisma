generator client {
    provider      = "prisma-client-js"
    binaryTargets = ["native", "linux-arm64-openssl-1.0.x"]
}

// generator erd {
//     provider = "prisma-erd-generator"
//     output   = "../docs/ERD.svg"
// }

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator nestgraphql {
    provider                = "node node_modules/prisma-nestjs-graphql"
    output                  = "../libs/generated-db-types"
    purgeOutput             = false
    combineScalarFilters    = true
    emitSingle              = true
    noAtomicOperations      = true
    // field validator
    fields_Validator_input  = true
    fields_Validator_output = true
    fields_Validator_model  = true
    fields_Validator_from   = "class-validator"
    // Args where|data nested validator
    decorate_1_type         = "*Args"
    decorate_1_field        = "@(data|where)"
    decorate_1_name         = ValidateNested
    decorate_1_from         = "class-validator"
    decorate_1_arguments    = "[]"
}

model User {
    id String @id @default(uuid())

    /// @Validator.IsEmail()
    email String @unique

    /// @Validator.IsString()
    /// @Validator.MaxLength(100)
    /// @Validator.MinLength(3)
    username String? @unique

    /// @Validator.IsString()
    /// @HideField()
    hashedPassword String?

    /// @Validator.IsString()
    /// @HideField()
    hashedRefreshToken String?
    createdAt          DateTime   @default(now())
    updatedAt          DateTime   @updatedAt
    userBooks          UserBook[]
    shelves            Shelf[]
}

// Table stores all books
model Book {
    id          String     @id @default(uuid())
    /// @Validator.IsString()
    title       String
    /// @Validator.IsString()
    author      String?
    /// @Validator.IsString()
    pubDate     String?
    /// @Validator.IsString()
    publisher   String?
    /// @Validator.IsString()
    coverImage  String?
    /// @Validator.IsString()
    description String?
    /// @Validator.IsString()
    pageCount   String?
    /// @Validator.IsString()
    isbn        String?
    /// @Validator.IsString()
    category    String?
    // Optional back reference that will not be used
    UserBooks   UserBook[]
}

// Table stores all user books
model UserBook {
    id           String  @id @default(uuid())
    userId       String
    bookId       String
    status       String
    rating       Int?
    dateStarted  String?
    dateFinished String?

    book       Book         @relation(fields: [bookId], references: [id])
    user       User?        @relation(fields: [userId], references: [id])
    // Optional back reference that will not be used
    ShelfEntry ShelfEntry[]
}

model Shelf {
    id               String  @id @default(uuid())
    shelfName        String
    shelfDescription String?
    userId           String
    dateTime         String?

    shelfEntries ShelfEntry[] // A shelf can have many entries
    user         User?        @relation(fields: [userId], references: [id])
}

model ShelfEntry {
    id         String  @id @default(uuid())
    shelfId    String
    userBookId String
    dateTime   String?

    shelf    Shelf    @relation(fields: [shelfId], references: [id])
    userBook UserBook @relation(fields: [userBookId], references: [id])
}
